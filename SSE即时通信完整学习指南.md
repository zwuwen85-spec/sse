# SSEå³æ—¶é€šä¿¡å®Œæ•´å­¦ä¹ æŒ‡å—

> åŸºäºgow.sse.baseé¡¹ç›®çš„å³æ—¶é€šä¿¡ç³»ç»Ÿå­¦ä¹ æ•™ç¨‹

---

## ç›®å½•

- [é˜¶æ®µ1: å³æ—¶é€šä¿¡åŸºç¡€æ¦‚å¿µå­¦ä¹ ](#é˜¶æ®µ1-å³æ—¶é€šä¿¡åŸºç¡€æ¦‚å¿µå­¦ä¹ )
- [é˜¶æ®µ2: SSEæŠ€æœ¯æ·±å…¥å­¦ä¹ ](#é˜¶æ®µ2-sseæŠ€æœ¯æ·±å…¥å­¦ä¹ )
- [é˜¶æ®µ3: Goè¯­è¨€å¹¶å‘ç¼–ç¨‹åŸºç¡€](#é˜¶æ®µ3-goè¯­è¨€å¹¶å‘ç¼–ç¨‹åŸºç¡€)
- [é˜¶æ®µ4: é€æ¨¡å—å­¦ä¹ é¡¹ç›®ä»£ç ](#é˜¶æ®µ4-é€æ¨¡å—å­¦ä¹ é¡¹ç›®ä»£ç )
- [é˜¶æ®µ5: åŠ¨æ‰‹å®è·µé¡¹ç›®](#é˜¶æ®µ5-åŠ¨æ‰‹å®è·µé¡¹ç›®)

---

# é˜¶æ®µ1: å³æ—¶é€šä¿¡åŸºç¡€æ¦‚å¿µå­¦ä¹ 

## 1.1 ä»€ä¹ˆæ˜¯å³æ—¶é€šä¿¡ï¼Ÿ

**å³æ—¶é€šä¿¡ï¼ˆInstant Messagingï¼Œç®€ç§°IMï¼‰**å°±æ˜¯ä¸¤ä¸ªæˆ–å¤šäººä¹‹é—´**å®æ—¶**äº¤æ¢æ¶ˆæ¯çš„æŠ€æœ¯ã€‚

### å³æ—¶é€šä¿¡çš„å…¸å‹åœºæ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å³æ—¶é€šä¿¡çš„å…¸å‹åœºæ™¯                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  å¾®ä¿¡èŠå¤©            â”‚  åœ¨çº¿å®¢æœ        â”‚  å¼¹å¹•           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”  æ¶ˆæ¯ â”Œâ”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”  é—®é¢˜ â”Œâ”€â”€â”€â”€â”             â”‚
â”‚  â”‚å¼ ä¸‰ â”‚ â”€â”€â”€â”€> â”‚æå›› â”‚ â”‚  â”‚ç”¨æˆ· â”‚ â”€â”€â”€â”€> â”‚å®¢æœ â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”˜ <â”€â”€â”€â”€ â””â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”˜ <â”€â”€â”€â”€ â””â”€â”€â”€â”€â”˜             â”‚
â”‚                                                          â”‚
â”‚  è‚¡ç¥¨è¡Œæƒ…            â”‚  æ¸¸æˆå®æ—¶çŠ¶æ€    â”‚  ååŒç¼–è¾‘       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”  æ¶¨è·Œ â”Œâ”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”  ç§»åŠ¨ â”Œâ”€â”€â”€â”€â”             â”‚
â”‚  â”‚æœåŠ¡å™¨â”‚ â”€â”€â”€â”€> â”‚å®¢æˆ·ç«¯â”‚ â”‚  â”‚ç©å®¶Aâ”‚ â”€â”€â”€â”€> â”‚ç©å®¶Bâ”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 1.2 IM ç³»ç»Ÿçš„æ ¸å¿ƒç»„æˆ

ä¸€ä¸ªå®Œæ•´çš„å³æ—¶é€šä¿¡ç³»ç»ŸåŒ…å«è¿™äº›éƒ¨åˆ†ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      IM ç³»ç»Ÿæ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚  ç”¨æˆ·A   â”‚     â”‚  ç”¨æˆ·B   â”‚     â”‚  ç”¨æˆ·C   â”‚           â”‚
â”‚   â”‚  å®¢æˆ·ç«¯   â”‚     â”‚  å®¢æˆ·ç«¯   â”‚     â”‚  å®¢æˆ·ç«¯   â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â”‚
â”‚         â”‚                 â”‚                 â”‚               â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                           â”‚                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚   ç½‘ç»œä¼ è¾“å±‚   â”‚                          â”‚
â”‚                    â”‚ (HTTP/WebSocket) â”‚                       â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                           â”‚                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚   æ¶ˆæ¯ç½‘å…³    â”‚  â†â”€â”€ SSEæ¨é€æœåŠ¡æ‰€åœ¨ä½ç½®  â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                           â”‚                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚         â–¼                 â–¼                 â–¼               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ æ¶ˆæ¯å­˜å‚¨   â”‚     â”‚ ç”¨æˆ·ç®¡ç†   â”‚     â”‚ ä¸šåŠ¡é€»è¾‘   â”‚           â”‚
â”‚   â”‚  (MySQL)  â”‚     â”‚ (Redis)   â”‚     â”‚  (Goä»£ç )  â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å„ç»„ä»¶èŒè´£è¯´æ˜

| ç»„ä»¶ | èŒè´£ | ç°å®ç±»æ¯” |
|------|------|----------|
| **å®¢æˆ·ç«¯** | æ˜¾ç¤ºæ¶ˆæ¯ã€å‘é€æ¶ˆæ¯ã€æ¥æ”¶æ¨é€ | æ‰‹æœºApp |
| **ç½‘ç»œä¼ è¾“å±‚** | æ•°æ®åœ¨ç½‘ç»œä¸Šä¼ è¾“ | å¿«é€’å…¬å¸ |
| **æ¶ˆæ¯ç½‘å…³** | ç®¡ç†è¿æ¥ã€æ¨é€æ¶ˆæ¯ | é‚®å±€åˆ†æ‹£ä¸­å¿ƒ |
| **æ¶ˆæ¯å­˜å‚¨** | ä¿å­˜èŠå¤©è®°å½• | æ¡£æ¡ˆé¦† |
| **ç”¨æˆ·ç®¡ç†** | åœ¨çº¿çŠ¶æ€ã€ç”¨æˆ·ä¿¡æ¯ | å‰å°ç™»è®°å¤„ |

## 1.3 æ¶ˆæ¯æ¨é€æŠ€æœ¯å¯¹æ¯”

è¿™æ˜¯å­¦ä¹ IMæœ€é‡è¦çš„åŸºç¡€çŸ¥è¯†ï¼å¿…é¡»ææ¸…æ¥šä¸åŒæŠ€æœ¯çš„åŒºåˆ«ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¸‰ç§æ¶ˆæ¯æ¨é€æŠ€æœ¯å¯¹æ¯”                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     ç‰¹æ€§        â”‚    è½®è¯¢        â”‚      SSE       â”‚   WebSocket  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é€šä¿¡æ–¹å‘        â”‚ å®¢æˆ·ç«¯â†’æœåŠ¡å™¨   â”‚ æœåŠ¡å™¨â†’å®¢æˆ·ç«¯   â”‚   åŒå‘       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å®æ—¶æ€§          â”‚ å·®(æœ‰å»¶è¿Ÿ)     â”‚ å¥½             â”‚ æœ€å¥½         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ èµ„æºæ¶ˆè€—        â”‚ é«˜(é¢‘ç¹è¯·æ±‚)   â”‚ ä½             â”‚ ä½           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æµè§ˆå™¨æ”¯æŒ      â”‚ å®Œå…¨æ”¯æŒ       â”‚ ç°ä»£æµè§ˆå™¨      â”‚ éœ€è¦å…¼å®¹å¤„ç†  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å®ç°éš¾åº¦        â”‚ ç®€å•           â”‚ ç®€å•           â”‚ å¤æ‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¿æ¥ç®¡ç†        â”‚ æ¯æ¬¡æ–­å¼€       â”‚ è‡ªåŠ¨é‡è¿       â”‚ éœ€æ‰‹åŠ¨å¤„ç†    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é€‚ç”¨åœºæ™¯        â”‚ ä½é¢‘æ•°æ®       â”‚ æ¶ˆæ¯é€šçŸ¥       â”‚ èŠå¤©å®¤ã€æ¸¸æˆ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç”¨ç”Ÿæ´»ä¾‹å­ç†è§£ä¸‰ç§æŠ€æœ¯

**1. è½®è¯¢ = ä½ ä¸åœåœ°é—®**
```
ä½ : æœ‰æ–°æ¶ˆæ¯å—ï¼Ÿ
æœåŠ¡å™¨: æ²¡æœ‰
(ç­‰5ç§’)
ä½ : æœ‰æ–°æ¶ˆæ¯å—ï¼Ÿ
æœåŠ¡å™¨: æ²¡æœ‰
(ç­‰5ç§’)
ä½ : æœ‰æ–°æ¶ˆæ¯å—ï¼Ÿ
æœåŠ¡å™¨: æœ‰ï¼
```

**2. SSE = ä½ åç€ç­‰ï¼ŒæœåŠ¡å‘˜é€æ¥**
```
ä½ : æœ‰æ¶ˆæ¯äº†å«æˆ‘
æœåŠ¡å™¨: å¥½çš„
(ä½ åšå…¶ä»–äº‹æƒ…...)
æœåŠ¡å™¨: ğŸ”” æœ‰æ–°æ¶ˆæ¯äº†ï¼
æœåŠ¡å™¨: ğŸ”” åˆæœ‰æ–°æ¶ˆæ¯äº†ï¼
```

**3. WebSocket = ä½ å’ŒæœåŠ¡å‘˜éšæ—¶äº¤æµ**
```
ä½ : æœ‰æ¶ˆæ¯å—ï¼Ÿ
æœåŠ¡å™¨: æœ‰ï¼åŒæ—¶æˆ‘ä¹Ÿæƒ³é—®ä½ ä¸ªäº‹...
ä½ : å¥½çš„ï¼Œæˆ‘è¿˜æœ‰äº‹è¦å‘Šè¯‰ä½ ...
æœåŠ¡å™¨: æˆ‘ä»¬å¯ä»¥éšæ—¶å¯¹è¯
```

## 1.4 å³æ—¶é€šä¿¡çš„æ ¸å¿ƒæ¦‚å¿µ

### æ¦‚å¿µ1ï¼šè¿æ¥

```
å®¢æˆ·ç«¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æœåŠ¡å™¨
   â†‘                    â†‘
   â”‚ ä¿æŒè¿™æ¡çº¿è·¯ç•…é€š     â”‚
   â”‚ å°±æ˜¯"è¿æ¥"          â”‚
```

**ä»£ç ä¸­çš„ä½“ç°ï¼š**
```go
// è¿™ä¸ª Client å°±ä»£è¡¨ä¸€ä¸ªè¿æ¥
type Client struct {
    ID       string
    UserID   string
    MessageChannel chan []byte  // é€šè¿‡è¿™ä¸ªé€šé“ä¼ æ¶ˆæ¯
}
```

### æ¦‚å¿µ2ï¼šæ¶ˆæ¯

```
æ¶ˆæ¯ = å¤´ + èº«ä½“

å¤´:
  - äº‹ä»¶ç±»å‹(event)
  - å‘é€è€…(from)
  - æ¥æ”¶è€…(to)

èº«ä½“:
  - å…·ä½“å†…å®¹ (JSON)
```

**SSEæ¶ˆæ¯æ ¼å¼ï¼š**
```
event: order_created    â† äº‹ä»¶ç±»å‹
data: {"no":"123"}      â† æ¶ˆæ¯å†…å®¹

                        â† ç©ºè¡Œè¡¨ç¤ºæ¶ˆæ¯ç»“æŸ
```

### æ¦‚å¿µ3ï¼šä¼šè¯

```
ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šæ¡è¿æ¥ï¼ˆå¤šä¸ªè®¾å¤‡ï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  è¿æ¥1  â”Œâ”€â”€â”€â”€â”
â”‚          â”‚ â—„â”€â”€â”€â”€â”€â–ºâ”‚    â”‚
â”‚  å¼ ä¸‰    â”‚  è¿æ¥2  â”‚SSE â”‚
â”‚  ç”¨æˆ·    â”‚ â—„â”€â”€â”€â”€â”€â–ºâ”‚æœåŠ¡â”‚
â”‚          â”‚  è¿æ¥3  â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â—„â”€â”€â”€â”€â”€â–ºâ”‚    â”‚
                 â””â”€â”€â”€â”€â”˜

ä¼šè¯ = ç”¨æˆ·æ‰€æœ‰è¿æ¥çš„é›†åˆ
```

---

# é˜¶æ®µ2: SSEæŠ€æœ¯æ·±å…¥å­¦ä¹ 

## 2.1 SSE çš„å·¥ä½œåŸç†

### HTTP vs SSE çš„æœ¬è´¨åŒºåˆ«

```
ä¼ ç»Ÿ HTTP è¯·æ±‚ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯                    æœåŠ¡å™¨                â”‚
â”‚    â”‚                        â”‚                   â”‚
â”‚    â”‚ â”€â”€â”€â”€ è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
â”‚    â”‚                        â”‚ å¤„ç†è¯·æ±‚            â”‚
â”‚    â”‚ <â”€â”€â”€â”€ å“åº” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
â”‚    â”‚                        â”‚                   â”‚
â”‚    â”‚ âœ… è¿æ¥ç»“æŸ              â”‚                   â”‚
â”‚    â”‚                        â”‚                   â”‚
â”‚    â”‚ â”€â”€â”€â”€ åˆè¦è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ (æ–°çš„è¿æ¥)         â”‚
â”‚    â”‚ <â”€â”€â”€â”€ åˆæ˜¯å“åº” â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
â”‚    â”‚                        â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SSE é•¿è¿æ¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯                    æœåŠ¡å™¨                â”‚
â”‚    â”‚                        â”‚                   â”‚
â”‚    â”‚ â”€â”€â”€â”€ å»ºç«‹è¿æ¥ â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
â”‚    â”‚                        â”‚ âœ… è¿æ¥ä¿æŒ         â”‚
â”‚    â”‚ <â”€â”€â”€â”€ æ¶ˆæ¯1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
â”‚    â”‚ <â”€â”€â”€â”€ æ¶ˆæ¯2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
â”‚    â”‚ <â”€â”€â”€â”€ æ¶ˆæ¯3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
â”‚    â”‚ <â”€â”€â”€â”€ å¿ƒè·³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
â”‚    â”‚                        â”‚ (ä¸€ç›´è¿æ¥ç€)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SSE è¿æ¥å»ºç«‹çš„å®Œæ•´è¿‡ç¨‹

```
æ­¥éª¤1ï¼šå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚
GET /woolive/sse?token=xxx
Header:
  Accept: text/event-stream
  Cache-Control: no-cache

æ­¥éª¤2ï¼šæœåŠ¡å™¨å“åº”
Status: 200 OK
Header:
  Content-Type: text/event-stream
  Cache-Control: no-cache
  Connection: keep-alive
  X-Accel-Buffering: no  â† å‘Šè¯‰nginxåˆ«ç¼“å†²

æ­¥éª¤3ï¼šå¼€å§‹ä¼ è¾“æ•°æ®
event: connection_id
data: {"connection_id":"abc-123"}

event: heartbeat
data: {"type":"initial","timestamp":...}

event: order_created
data: {"order_no":"123"}

(è¿™æ¡è¿æ¥ä¸€ç›´å¼€ç€ï¼Œéšæ—¶å¯ä»¥å‘æ•°æ®)
```

## 2.2 SSE æ¶ˆæ¯æ ¼å¼è¯¦è§£

### æ ‡å‡†æ ¼å¼

```
event: message_type      â† å¯é€‰ï¼Œäº‹ä»¶åç§°
data: message_content    â† å¿…é¡»ï¼Œæ¶ˆæ¯å†…å®¹
data: more_data          â† å¤šè¡Œdataä¼šæ‹¼åœ¨ä¸€èµ·
id: 12345                â† å¯é€‰ï¼Œæ¶ˆæ¯ID
retry: 3000              â† å¯é€‰ï¼Œé‡è¿é—´éš”(æ¯«ç§’)

                         â† å¿…é¡»çš„ç©ºè¡Œï¼Œè¡¨ç¤ºæ¶ˆæ¯ç»“æŸ
```

### ä¸åŒç±»å‹æ¶ˆæ¯çš„ä¾‹å­

```
ã€æ¶ˆæ¯1ï¼šé€šçŸ¥ã€‘
event: notification
data: {"title":"æ–°è®¢å•","content":"è®¢å•123å·²åˆ›å»º"}

ã€æ¶ˆæ¯2ï¼šå¿ƒè·³ã€‘
event: heartbeat
data: {"type":"periodic","timestamp":1234567890}

ã€æ¶ˆæ¯3ï¼šèŠå¤©ã€‘
event: chat
id: msg-456
data: {"from":"user_001","to":"user_002","text":"ä½ å¥½"}

ã€æ¶ˆæ¯4ï¼šåªæœ‰dataï¼Œæ²¡æœ‰eventã€‘
data: {"message":"ç®€å•æ¶ˆæ¯"}
(å®¢æˆ·ç«¯ä¼šåœ¨ message äº‹ä»¶ä¸­æ”¶åˆ°)
```

## 2.3 å¿ƒè·³æœºåˆ¶ - ä¿å‘½çš„å…³é”®

### ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³ï¼Ÿ

```
æ²¡æœ‰å¿ƒè·³çš„æƒ…å†µï¼š
å®¢æˆ·ç«¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æœåŠ¡å™¨
   30ç§’æ²¡æ•°æ®äº†...
   è·¯ç”±å™¨/ä»£ç†ï¼š"è¿™è¿æ¥æ€ä¹ˆæ²¡åŠ¨é™ï¼Ÿè¶…æ—¶ï¼æ–­å¼€ï¼"
   âŒ è¿æ¥è¢«åˆ‡æ–­

æœ‰å¿ƒè·³çš„æƒ…å†µï¼š
å®¢æˆ·ç«¯ â”€â”€â”€â”€â”€â”€â”€â”€< ğŸ”” å¿ƒè·³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æœåŠ¡å™¨
   30ç§’å â”€â”€â”€â”€â”€< ğŸ”” å¿ƒè·³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æœåŠ¡å™¨
   30ç§’å â”€â”€â”€â”€â”€< ğŸ”” å¿ƒè·³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æœåŠ¡å™¨
   âœ… è¿æ¥ä¸€ç›´æ´»ç€
```

### æœ¬é¡¹ç›®ä¸­çš„ä¸‰ç§å¿ƒè·³

```
ã€å¿ƒè·³ç±»å‹1ï¼šinitial - è¿æ¥æ—¶ç«‹å³å‘é€ã€‘
ä½œç”¨ï¼šç¡®è®¤è¿æ¥æˆåŠŸå»ºç«‹
æ—¶æœºï¼šå®¢æˆ·ç«¯è¿ä¸ŠæœåŠ¡å™¨çš„é‚£ä¸€åˆ»
ä¾‹å­ï¼š
event: heartbeat
data: {"type":"initial","client_id":"abc-123","user_id":"user_001"}

ã€å¿ƒè·³ç±»å‹2ï¼šperiodic - å®šæ—¶å…¨å±€å¹¿æ’­ã€‘
ä½œç”¨ï¼šé˜²æ­¢ä¸­é—´è®¾å¤‡è¶…æ—¶æ–­å¼€è¿æ¥
æ—¶æœºï¼šæ¯30ç§’ï¼ˆå¯é…ç½®ï¼‰å¹¿æ’­ç»™æ‰€æœ‰å®¢æˆ·ç«¯
ä¾‹å­ï¼š
event: heartbeat
data: {"type":"periodic","timestamp":1234567890}

ã€å¿ƒè·³ç±»å‹3ï¼šhealthcheck - å•ç‹¬æ£€æµ‹ã€‘
ä½œç”¨ï¼šæ£€æµ‹å•ä¸ªè¿æ¥æ˜¯å¦è¿˜æ´»ç€
æ—¶æœºï¼šæ¯ä¸ªè¿æ¥å†…éƒ¨å®šæ—¶å™¨ï¼Œ90ç§’æ£€æµ‹ä¸€æ¬¡
ä¾‹å­ï¼š
event: heartbeat
data: {"type":"healthcheck","client_id":"abc-123","user_id":"user_001"}
```

### å¿ƒè·³æ—¶é—´å…³ç³»å›¾

```
è¿æ¥å»ºç«‹æ—¶ï¼š
â”œâ”€ å‘é€ initial å¿ƒè·³
â”‚
â”œâ”€ å¯åŠ¨ healthcheck å®šæ—¶å™¨ (90ç§’)
â”‚  0ç§’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 90ç§’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 180ç§’
â”‚  å‘é€ healthcheck å¿ƒè·³          å‘é€ healthcheck å¿ƒè·³
â”‚
â””â”€ å…¨å±€ periodic å¹¿æ’­ (30ç§’)
   0ç§’ â”€â”€â”€> 30ç§’ â”€â”€â”€> 60ç§’ â”€â”€â”€> 90ç§’ â”€â”€â”€> 120ç§’
   å¹¿æ’­      å¹¿æ’­       å¹¿æ’­       å¹¿æ’­       å¹¿æ’­

ç»“è®ºï¼šæ¯30ç§’è‡³å°‘ä¼šæœ‰ä¸€ä¸ªå¿ƒè·³ï¼Œè¿æ¥ä¸ä¼šè¶…æ—¶
```

## 2.4 å‰ç«¯æ¥æ”¶SSEçš„å®Œæ•´ç¤ºä¾‹

```html
<!DOCTYPE html>
<html>
<head>
    <title>SSE èŠå¤©å®¤ç¤ºä¾‹</title>
    <style>
        #messages {
            height: 400px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            padding: 10px;
        }
        .message {
            margin: 5px 0;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 4px;
        }
        .heartbeat {
            color: #999;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h2>å³æ—¶é€šä¿¡æ¼”ç¤º</h2>
    <div>
        <input type="text" id="message" placeholder="è¾“å…¥æ¶ˆæ¯...">
        <button onclick="sendMessage()">å‘é€</button>
    </div>
    <div id="messages"></div>

    <script>
        // 1. å»ºç«‹SSEè¿æ¥
        const eventSource = new EventSource(
            '/woolive/sse?token=' + getToken()
        );

        const messagesDiv = document.getElementById('messages');

        // 2. ç›‘å¬è¿æ¥IDäº‹ä»¶
        eventSource.addEventListener('connection_id', function(e) {
            const data = JSON.parse(e.data);
            addMessage('ç³»ç»Ÿ', 'è¿æ¥æˆåŠŸï¼ID: ' + data.connection_id);
        });

        // 3. ç›‘å¬å¿ƒè·³äº‹ä»¶
        eventSource.addEventListener('heartbeat', function(e) {
            const data = JSON.parse(e.data);
            console.log('æ”¶åˆ°å¿ƒè·³:', data.type, data.timestamp);
        });

        // 4. ç›‘å¬èŠå¤©æ¶ˆæ¯
        eventSource.addEventListener('chat', function(e) {
            const data = JSON.parse(e.data);
            addMessage(data.from, data.text);
        });

        // 5. ç›‘å¬è®¢å•é€šçŸ¥
        eventSource.addEventListener('order_created', function(e) {
            const data = JSON.parse(e.data);
            addMessage('è®¢å•é€šçŸ¥', 'æ–°è®¢å•: ' + data.order_no);
        });

        // 6. ç›‘å¬é”™è¯¯
        eventSource.onerror = function(e) {
            console.error('è¿æ¥é”™è¯¯:', e);
            addMessage('ç³»ç»Ÿ', 'è¿æ¥å‡ºé”™ï¼Œæ­£åœ¨é‡è¿...');
        };

        // 7. å‘é€æ¶ˆæ¯å‡½æ•°ï¼ˆé€šè¿‡HTTP POSTï¼‰
        function sendMessage() {
            const input = document.getElementById('message');
            const text = input.value;
            if (!text) return;

            fetch('/api/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text: text})
            });

            input.value = '';
        }

        // 8. è¾…åŠ©å‡½æ•°
        function addMessage(from, text) {
            const div = document.createElement('div');
            div.className = 'message';
            div.textContent = from + ': ' + text;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function getToken() {
            return localStorage.getItem('jwt_token') || '';
        }

        // 9. é¡µé¢å…³é—­æ—¶æ–­å¼€è¿æ¥
        window.onbeforeunload = function() {
            eventSource.close();
        };
    </script>
</body>
</html>
```

## 2.5 SSE çš„ä¼˜ç¼ºç‚¹æ€»ç»“

### âœ… ä¼˜ç‚¹

| ä¼˜ç‚¹ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| ç®€å• | åŸºäºHTTPï¼Œæ— éœ€é¢å¤–åè®® | å¿«é€Ÿå¼€å‘ |
| è‡ªåŠ¨é‡è¿ | æµè§ˆå™¨è‡ªåŠ¨å¤„ç†æ–­çº¿é‡è¿ | ç½‘ç»œä¸ç¨³å®šç¯å¢ƒ |
| æœåŠ¡å™¨æ¨é€ | æœåŠ¡å™¨ä¸»åŠ¨å‘æ¶ˆæ¯ | æ¶ˆæ¯é€šçŸ¥ã€çŠ¶æ€æ›´æ–° |
| æ–‡æœ¬æ ¼å¼ | æ¶ˆæ¯æ˜¯æ–‡æœ¬ï¼Œæ˜“äºè°ƒè¯• | å¼€å‘è°ƒè¯•å‹å¥½ |

### âŒ ç¼ºç‚¹

| ç¼ºç‚¹ | è¯´æ˜ | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| å•å‘é€šä¿¡ | åªèƒ½æœåŠ¡å™¨â†’å®¢æˆ·ç«¯ | é…åˆHTTP POSTå®ç°åŒå‘ |
| æ–­çº¿é‡è¿ä¸¢æ¶ˆæ¯ | é‡è¿æœŸé—´çš„æ¶ˆæ¯ä¼šä¸¢å¤± | æœåŠ¡ç«¯æ¶ˆæ¯å­˜å‚¨+ç¦»çº¿æ¶ˆæ¯ |
| è¿æ¥æ•°é™åˆ¶ | æ¯ä¸ªåŸŸåé™åˆ¶6ä¸ªè¿æ¥ | åˆç†è§„åˆ’è¿æ¥æ•° |
| ä¸æ”¯æŒäºŒè¿›åˆ¶ | åªèƒ½ä¼ è¾“æ–‡æœ¬ | Base64ç¼–ç  |

---

# é˜¶æ®µ3: Goè¯­è¨€å¹¶å‘ç¼–ç¨‹åŸºç¡€

å³æ—¶é€šä¿¡ç³»ç»Ÿæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯**é«˜å¹¶å‘**ï¼šæˆåƒä¸Šä¸‡ç”¨æˆ·åŒæ—¶è¿æ¥ã€‚Goè¯­è¨€çš„å¹¶å‘ç‰¹æ€§éå¸¸é€‚åˆè¿™ç§åœºæ™¯ã€‚

## 3.1 å¹¶å‘åŸºç¡€æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯å¹¶å‘ï¼Ÿ

```
ã€ä¸²è¡Œã€‘ - ä¸€æ¬¡åªåšä¸€ä»¶äº‹
æ—¶é—´ â†’
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ä»»åŠ¡1 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
            ä»»åŠ¡2         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
                        ä»»åŠ¡3         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
æ€»è€—æ—¶ï¼š8 + 8 + 8 = 24

ã€å¹¶å‘ã€‘ - åŒæ—¶åšå¤šä»¶äº‹
æ—¶é—´ â†’
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ä»»åŠ¡1 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    ä»»åŠ¡2 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    ä»»åŠ¡3 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
æ€»è€—æ—¶ï¼š8 (ä¸‰ä¸ªä»»åŠ¡åŒæ—¶è¿›è¡Œ)
```

### ä¸ºä»€ä¹ˆå³æ—¶é€šä¿¡éœ€è¦å¹¶å‘ï¼Ÿ

```
æœåŠ¡å™¨éœ€è¦åŒæ—¶å¤„ç†ï¼š
â”œâ”€ ç”¨æˆ·Açš„è¿æ¥ â”€â”€> goroutine 1 â”€â”€> ç›‘å¬Açš„æ¶ˆæ¯
â”œâ”€ ç”¨æˆ·Bçš„è¿æ¥ â”€â”€> goroutine 2 â”€â”€> ç›‘å¬Bçš„æ¶ˆæ¯
â”œâ”€ ç”¨æˆ·Cçš„è¿æ¥ â”€â”€> goroutine 3 â”€â”€> ç›‘å¬Cçš„æ¶ˆæ¯
â”œâ”€ ç”¨æˆ·Dçš„è¿æ¥ â”€â”€> goroutine 4 â”€â”€> ç›‘å¬Dçš„æ¶ˆæ¯
â””â”€ ...ï¼ˆ10000ä¸ªç”¨æˆ· = 10000ä¸ªgoroutineï¼‰

å¦‚æœä¸²è¡Œå¤„ç†ï¼Œç”¨æˆ·Aå¤„ç†å®Œæ‰èƒ½å¤„ç†Bï¼Œ
é‚£Bè¦ç­‰å¾ˆä¹…ï¼
```

## 3.2 Goroutine - å¹¶å‘çš„åŸºæœ¬å•ä½

### ä»€ä¹ˆæ˜¯Goroutineï¼Ÿ

**Goroutine = Goè¯­è¨€çš„è½»é‡çº§çº¿ç¨‹**

```
å¯¹æ¯”ä¼ ç»Ÿçº¿ç¨‹ï¼š
æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼š        Goroutineï¼š
  æ¯ä¸ªçº¿ç¨‹ ~2MBå†…å­˜      æ¯ä¸ª ~2KBå†…å­˜
  åˆ›å»ºæ…¢                åˆ›å»ºå¿«
  åˆ‡æ¢å¼€é”€å¤§            åˆ‡æ¢å¼€é”€å°
  æœ€å¤šå‡ åƒä¸ª            å¯ä»¥è½»æ¾ä¸Šç™¾ä¸‡ä¸ª
```

### åŸºæœ¬ç”¨æ³•

```go
// 1. æ™®é€šå‡½æ•°
func sayHello() {
    fmt.Println("Hello")
}

// 2. å¯åŠ¨ goroutineï¼ˆåœ¨å‡½æ•°å‰åŠ  goï¼‰
go sayHello()  // ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…æ‰§è¡Œå®Œæˆ

// 3. åŒ¿åå‡½æ•° goroutine
go func() {
    fmt.Println("æˆ‘æ˜¯åŒ¿ågoroutine")
}()

// 4. å¸¦å‚æ•°çš„ goroutine
func greet(name string) {
    fmt.Println("Hello,", name)
}
go greet("å¼ ä¸‰")
```

### æœ¬é¡¹ç›®ä¸­çš„goroutineä½¿ç”¨

```go
// æœ¬é¡¹ç›®ä¸­å¯åŠ¨äº†å¤šä¸ª goroutineï¼š

// 1. ClientManager ä¸»å¾ªç¯ goroutine
go clientManager.Run()
// ä½œç”¨ï¼šä¸æ–­ç›‘å¬æ³¨å†Œã€æ³¨é”€ã€æ¶ˆæ¯æ¨é€ç­‰äº‹ä»¶

// 2. å®šæ—¶å¹¿æ’­ goroutine
go tasks.StartPeriodicBroadcast(ctx)
// ä½œç”¨ï¼šæ¯30ç§’å¹¿æ’­å¿ƒè·³æ¶ˆæ¯

// 3. æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥çš„ Listen goroutine
sseClient.Listen(r.Context())
// ä½œç”¨ï¼šç›‘å¬è¿™ä¸ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯é€šé“ï¼Œå‘é€æ¶ˆæ¯

// æ€»goroutineæ•° = 1(ä¸») + 1(ç®¡ç†å™¨) + 1(å¹¿æ’­) + N(å®¢æˆ·ç«¯æ•°)
// å¦‚æœæœ‰10000ä¸ªå®¢æˆ·ç«¯ï¼Œå°±æœ‰10003ä¸ªgoroutineï¼
```

## 3.3 Channel - goroutineä¹‹é—´çš„é€šä¿¡ç®¡é“

### ä»€ä¹ˆæ˜¯Channelï¼Ÿ

```
Channel = ç®¡é“

goroutine A â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•> goroutine B
              (channel)
    å‘é€æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æ¥æ”¶æ•°æ®

å°±åƒé€å¿«é€’ï¼š
AæŠŠåŒ…è£¹æ”¾è¿›ç®¡é“ â†’ Bä»ç®¡é“å–å‡ºåŒ…è£¹
```

### åŸºæœ¬ç”¨æ³•

```go
// 1. åˆ›å»ºchannel
ch := make(chan int)        // æ•´æ•°channel
ch := make(chan string)     // å­—ç¬¦ä¸²channel
ch := make(chan []byte)     // å­—èŠ‚åˆ‡ç‰‡channel
ch := make(chan []byte, 10) // å¸¦ç¼“å†²çš„channelï¼ˆå®¹é‡10ï¼‰

// 2. å‘é€æ•°æ®
ch <- "hello"  // æŠŠ "hello" æ”¾è¿›channel

// 3. æ¥æ”¶æ•°æ®
msg := <-ch    // ä»channelå–å‡ºæ•°æ®

// 4. å®Œæ•´ä¾‹å­
ch := make(chan string)

// å‘é€è€…goroutine
go func() {
    ch <- "ping"  // å‘é€
}()

// æ¥æ”¶è€…
msg := <-ch  // æ¥æ”¶ "ping"
fmt.Println(msg)
```

### æœ¬é¡¹ç›®ä¸­çš„Channelä½¿ç”¨

```go
// Client ç»“æ„ä½“ä¸­çš„ MessageChannel
type Client struct {
    MessageChannel chan []byte  // æ¶ˆæ¯ç®¡é“
}

// å‘é€æ¶ˆæ¯åˆ°channel
func (c *Client) Send(message []byte) bool {
    select {
    case c.MessageChannel <- message:
        return true  // æˆåŠŸæ”¾å…¥
    default:
        return false // é€šé“æ»¡äº†ï¼Œä¸¢å¼ƒ
    }
}

// ä»channelæ¥æ”¶æ¶ˆæ¯ï¼ˆåœ¨Listenä¸­ï¼‰
case message := <-c.MessageChannel:
    // å¤„ç†æ¶ˆæ¯
    fmt.Fprintf(c.ResponseWriter, "data: %s\n\n", message)
```

### ç¼“å†²Channel vs æ— ç¼“å†²Channel

```
ã€æ— ç¼“å†² Channelã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘é€æ–¹  â”‚ â”€â”€â”€ blocking â”€â”€â”€â”€> â”‚ æ¥æ”¶æ–¹  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   (å¿…é¡»æœ‰äººæ”¶)      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼šåŒæ­¥é€šä¿¡ï¼Œå‘é€æ–¹ä¼šé˜»å¡ç›´åˆ°æœ‰äººæ¥æ”¶

ch := make(chan int)
ch <- 1  // ä¼šå¡ä½ï¼Œç›´åˆ°æœ‰åœ°æ–¹æ¥æ”¶

ã€ç¼“å†² Channelã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘é€æ–¹  â”‚ â†’ â”‚ 1 â”‚ 2 â”‚ 3 â”‚ â†’ â”‚ æ¥æ”¶æ–¹  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              (å®¹é‡ä¸º3çš„ç¼“å†²åŒº)

ç‰¹ç‚¹ï¼šå¼‚æ­¥é€šä¿¡ï¼Œç¼“å†²åŒºæ²¡æ»¡å°±å¯ä»¥å‘é€
ch := make(chan int, 3)
ch <- 1  // ä¸ä¼šå¡ï¼Œç›´æ¥æ”¾è¿›ç¼“å†²åŒº
ch <- 2  // ä¸ä¼šå¡
ch <- 3  // ä¸ä¼šå¡
ch <- 4  // å¡ä½ï¼ç¼“å†²åŒºæ»¡äº†
```

**æœ¬é¡¹ç›®çš„é€‰æ‹©ï¼š**
```go
MessageChannel: make(chan []byte, 50)  // ç¼“å†²50æ¡æ¶ˆæ¯
```
ä¸ºä»€ä¹ˆ50ï¼Ÿ
- å¤ªå°ï¼šå®¹æ˜“æ»¡ï¼Œæ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒ
- å¤ªå¤§ï¼šå ç”¨å†…å­˜å¤š
- 50æ˜¯ä¸ªå¹³è¡¡ç‚¹

## 3.4 Select - å¤šé€šé“ç›‘å¬

### ä»€ä¹ˆæ˜¯Selectï¼Ÿ

```
Select = åŒæ—¶ç›‘å¬å¤šä¸ªchannel

          â”Œâ”€â”€ channel A â”€â”€â”
channel â”€â”€â”¼â”€â”€ channel B â”€â”€â”¼â”€â”€> select
          â”Œâ”€â”€ channel C â”€â”€â”˜

å“ªä¸ªchannelæœ‰æ•°æ®ï¼Œå°±å¤„ç†å“ªä¸ª
```

### åŸºæœ¬ç”¨æ³•

```go
select {
case msg := <-ch1:
    fmt.Println("ä»ch1æ”¶åˆ°:", msg)
case msg := <-ch2:
    fmt.Println("ä»ch2æ”¶åˆ°:", msg)
case <-time.After(3 * time.Second):
    fmt.Println("3ç§’è¶…æ—¶äº†")
}
```

### æœ¬é¡¹ç›®ä¸­çš„Selectä½¿ç”¨

```go
// Client.Listen ä¸­çš„ select - åŒæ—¶ç›‘å¬4ä¸ª"äº‹ä»¶æº"
for {
    select {
    // äº‹ä»¶1: æ”¶åˆ°æ¶ˆæ¯
    case message := <-c.MessageChannel:
        // å‘é€ç»™å®¢æˆ·ç«¯
        fmt.Fprintf(w, "data: %s\n\n", message)
        flusher.Flush()

    // äº‹ä»¶2: 30ç§’ç›‘æ§å®šæ—¶å™¨
    case <-connectionMonitorTicker.C:
        // æ‰“å°è¿æ¥çŠ¶æ€
        log.Infof("è¿æ¥æ­£å¸¸ï¼Œå·²æŒç»­: %v", duration)

    // äº‹ä»¶3: 90ç§’å¥åº·æ£€æŸ¥å®šæ—¶å™¨
    case <-healthCheckTicker.C:
        // å‘é€å¿ƒè·³
        c.sendEvent("heartbeat", heartbeatData)

    // äº‹ä»¶4: è¿æ¥æ–­å¼€
    case <-ctx.Done():
        // æ¸…ç†èµ„æº
        return
    }
}
```

**ç”¨ç”Ÿæ´»ä¾‹å­ç†è§£selectï¼š**
```
ä½ æ­£åœ¨å®¶é‡Œï¼ŒåŒæ—¶å…³æ³¨4ä»¶äº‹ï¼š
â”œâ”€ æ‰‹æœºå“äº† â†’ æ¥ç”µè¯
â”œâ”€ é—¨é“ƒå“äº† â†’ å¼€é—¨
â”œâ”€ æ°´å¼€äº† â†’ å…³ç«
â””â”€ é—¹é’Ÿå“äº† â†’ èµ·åºŠ

selectè®©ä½ èƒ½åŒæ—¶ç›‘å¬æ‰€æœ‰äº‹ï¼Œå“ªä»¶å‘ç”Ÿå°±å¤„ç†å“ªä»¶
```

## 3.5 å¹¶å‘å®‰å…¨ - Sync.Map

### ä»€ä¹ˆæ˜¯å¹¶å‘å®‰å…¨é—®é¢˜ï¼Ÿ

```go
// âŒ å±é™©ï¼å¤šä¸ªgoroutineåŒæ—¶ä¿®æ”¹map
clients := make(map[string]*Client)

// goroutine 1
clients["user1"] = client1

// goroutine 2 åŒæ—¶ä¹Ÿåœ¨å†™å…¥
clients["user2"] = client2

// ğŸ’¥ panic: concurrent map writes!
// Goçš„mapä¸æ˜¯å¹¶å‘å®‰å…¨çš„ï¼
```

### è§£å†³æ–¹æ¡ˆï¼šSync.Map

```go
// âœ… ä½¿ç”¨ sync.Map
var clients sync.Map

// goroutine 1
clients.Store("user1", client1)  // å­˜å‚¨å€¼

// goroutine 2
clients.Store("user2", client2)  // ä¸ä¼španicï¼

// è¯»å–å€¼
if val, ok := clients.Load("user1"); ok {
    client := val.(*Client)
    // ä½¿ç”¨client
}

// éå†
clients.Range(func(key, value interface{}) bool {
    fmt.Println(key, value)
    return true  // ç»§ç»­éå†
})
```

### æœ¬é¡¹ç›®ä¸­çš„Sync.Mapä½¿ç”¨

```go
type ClientManager struct {
    Clients      sync.Map  // å…¨éƒ¨å®¢æˆ·ç«¯
    UserClients  sync.Map  // æŒ‰ç”¨æˆ·åˆ†ç»„çš„å®¢æˆ·ç«¯
}

// æ³¨å†Œå®¢æˆ·ç«¯
func (m *ClientManager) registerClient(client *Client) {
    m.Clients.Store(client.ID, client)  // å…¨å±€ç´¢å¼•

    // æŒ‰ç”¨æˆ·åˆ†ç»„
    userMap, _ := m.UserClients.LoadOrStore(client.UserID, &sync.Map{})
    userMap.(*sync.Map).Store(client.ID, client)
}

// æŸ¥æ‰¾ç”¨æˆ·çš„æ‰€æœ‰å®¢æˆ·ç«¯
func (m *ClientManager) sendToUser(userID string) {
    if val, ok := m.UserClients.Load(userID); ok {
        userMap := val.(*sync.Map)
        userMap.Range(func(key, value interface{}) bool {
            client := value.(*Client)
            client.Send(message)
            return true
        })
    }
}
```

## 3.6 å¹¶å‘æ¨¡å¼æ€»ç»“

### æœ¬é¡¹ç›®ç”¨åˆ°çš„å¹¶å‘æ¨¡å¼

```
ã€æ¨¡å¼1ï¼šWorker Pool - å·¥ä½œæ± ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»»åŠ¡é˜Ÿåˆ—                                â”‚
â”‚  [task1][task2][task3][task4][task5]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ select  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼             â–¼        â–¼        â–¼
  å¤„ç†task1    å¤„ç†task2  å¤„ç†task3  ...

æœ¬é¡¹ç›®ï¼šClientManager.Run() ç›‘å¬å¤šä¸ªchannel

ã€æ¨¡å¼2ï¼šFan-Out - åˆ†å‘ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¨é€æ¶ˆæ¯  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€> Client A
     â”œâ”€â”€> Client B
     â”œâ”€â”€> Client C
     â””â”€â”€> Client D

æœ¬é¡¹ç›®ï¼šå‘ç”¨æˆ·çš„æ‰€æœ‰å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯

ã€æ¨¡å¼3ï¼šPipeline - ç®¡é“ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ æ¥æ”¶  â”‚ â†’ â”‚ å¤„ç†  â”‚ â†’ â”‚ å‘é€  â”‚
â”‚è¯·æ±‚  â”‚    â”‚é€»è¾‘  â”‚    â”‚å“åº”  â”‚
â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜

æœ¬é¡¹ç›®ï¼šè¯·æ±‚ â†’ éªŒè¯ â†’ æ¨é€ â†’ å“åº”
```

### å¹¶å‘ç¼–ç¨‹çš„å…³é”®è¦ç‚¹

| è¦ç‚¹ | è¯´æ˜ | æœ¬é¡¹ç›®åº”ç”¨ |
|------|------|-----------|
| **éš”ç¦»** | æ¯ä¸ªgoroutineç‹¬ç«‹å·¥ä½œ | æ¯ä¸ªClientç‹¬ç«‹Listen |
| **é€šä¿¡** | é€šè¿‡channelé€šä¿¡ | MessageChannelä¼ é€’æ¶ˆæ¯ |
| **å®‰å…¨** | ä½¿ç”¨sync.Mapä¿è¯å®‰å…¨ | Clients/UserClientsç”¨sync.Map |
| **ç›‘æ§** | å®šæ—¶æ£€æŸ¥çŠ¶æ€ | å¿ƒè·³æœºåˆ¶æ£€æµ‹è¿æ¥å¥åº· |
| **æ¸…ç†** | goroutineé€€å‡ºè¦æ¸…ç†èµ„æº | deferæ³¨é”€Client |

---

# é˜¶æ®µ4: é€æ¨¡å—å­¦ä¹ é¡¹ç›®ä»£ç 

ç°åœ¨æˆ‘ä»¬å·²ç»æŒæ¡äº†åŸºç¡€ï¼Œå¼€å§‹æ·±å…¥å­¦ä¹ é¡¹ç›®çš„å…·ä½“å®ç°ã€‚

## 4.1 å­¦ä¹ è·¯çº¿å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å­¦ä¹ é¡ºåº                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  â‘  æ•°æ®ç»“æ„å®šä¹‰     â†â”€â”€ æœ€ç®€å•ï¼Œå…ˆä»è¿™é‡Œå¼€å§‹          â”‚
â”‚     â†“                                            â”‚
â”‚  â‘¡ å®¢æˆ·ç«¯ç®¡ç†å™¨     â†â”€â”€ æ ¸å¿ƒé€»è¾‘                      â”‚
â”‚     â†“                                            â”‚
â”‚  â‘¢ è¿æ¥å¤„ç†é€»è¾‘     â†â”€â”€ å¤„ç†HTTPè¯·æ±‚                 â”‚
â”‚     â†“                                            â”‚
â”‚  â‘£ æ¨é€é€»è¾‘         â†â”€â”€ å¤„ç†gRPCè¯·æ±‚                â”‚
â”‚     â†“                                            â”‚
â”‚  â‘¤ æœåŠ¡å¯åŠ¨         â†â”€â”€ æŠŠæ‰€æœ‰ç»„ä»¶ç»„åˆèµ·æ¥            â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 4.2 æ¨¡å—â‘ ï¼šæ•°æ®ç»“æ„å®šä¹‰

### ä»£ç ç»“æ„è§£æ

```go
// 1. å¸¸é‡å®šä¹‰ - äº‹ä»¶åç§°
const (
    HeartbeatEventName     = "heartbeat"      // å¿ƒè·³äº‹ä»¶
    ConnectionIDEventName  = "connection_id"  // è¿æ¥IDäº‹ä»¶
    ReconnectEventName     = "reconnect"      // é‡è¿äº‹ä»¶
)

// 2. å¿ƒè·³ç±»å‹å¸¸é‡
const (
    HeartbeatTypeInitial     = "initial"      // è¿æ¥æ—¶
    HeartbeatTypePeriodic    = "periodic"     // å®šæ—¶å¹¿æ’­
    HeartbeatTypeHealthcheck = "healthcheck"  // å¥åº·æ£€æŸ¥
)

// 3. æ•°æ®ç»“æ„
type HeartbeatData struct {
    TimestampMs   int64  `json:"timestamp"`   // æ—¶é—´æˆ³
    TimeStr       string `json:"data"`        // æ—¶é—´å­—ç¬¦ä¸²
    HeartbeatType string `json:"type"`        // ç±»å‹
    ClientID      string `json:"client_id"`   // å®¢æˆ·ç«¯ID
    UserID        string `json:"user_id"`     // ç”¨æˆ·ID
}
```

### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

**ç”¨é¤å…ç±»æ¯”ç†è§£æ•°æ®ç»“æ„ï¼š**
```
HeartbeatData = å¿ƒè·³å¡
â”œâ”€ TimestampMs   â†’ åˆ·å¡æ—¶é—´
â”œâ”€ TimeStr       â†’ å¯è¯»æ—¶é—´
â”œâ”€ HeartbeatType â†’ å¿ƒè·³ç±»å‹ï¼ˆåˆšæ¥åä¸‹çš„ / å®šæ—¶æŠ¥åˆ°çš„ / å¥åº·æ£€æŸ¥ï¼‰
â”œâ”€ ClientID      â†’ æ¡Œå·
â””â”€ UserID        â†’ å®¢äººå§“å
```

## 4.3 æ¨¡å—â‘¡ï¼šå®¢æˆ·ç«¯ç®¡ç†å™¨

è¿™æ˜¯æœ€æ ¸å¿ƒçš„æ¨¡å—ã€‚

### ClientManager å®Œæ•´è§£æ

```go
// æ ¸å¿ƒæ•°æ®ç»“æ„
type ClientManager struct {
    // ä¸¤ä¸ªå­˜å‚¨ï¼ˆå¹¶å‘å®‰å…¨ï¼‰
    Clients      sync.Map  // å…¨éƒ¨å®¢æˆ·ç«¯ï¼š{clientID â†’ Client}
    UserClients  sync.Map  // æŒ‰ç”¨æˆ·åˆ†ç»„ï¼š{userID â†’ {clientID â†’ Client}}

    // å››ä¸ªé€šé“
    registerChan   chan *Client      // æ–°å®¢äººæ¥äº†
    unregisterChan chan *Client      // å®¢äººèµ°äº†
    broadcastChan  chan []byte       // å¹¿æ’­æ¶ˆæ¯
    userMsgChan    chan userMessage  // ç»™ç‰¹å®šå®¢äººçš„æ¶ˆæ¯

    svcCtx *svc.ServiceContext       // æœåŠ¡ä¸Šä¸‹æ–‡
}
```

### å†…å­˜ç»“æ„å›¾

```
Clients:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "client_001" â†’ Client{å¼ ä¸‰çš„æ¡Œé¢}    â”‚
â”‚ "client_002" â†’ Client{æå››çš„æ¡Œé¢}    â”‚
â”‚ "client_003" â†’ Client{å¼ ä¸‰çš„æ‰‹æœº}    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

UserClients:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "å¼ ä¸‰" â†’ {                          â”‚
â”‚           "client_001" â†’ Client{},   â”‚
â”‚           "client_003" â†’ Client{}    â”‚
â”‚         }                            â”‚
â”‚ "æå››" â†’ {                          â”‚
â”‚           "client_002" â†’ Client{}    â”‚
â”‚         }                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æ–¹æ³•è¯¦è§£

#### 1. Register - æ³¨å†Œæ–°å®¢æˆ·ç«¯

```go
func (manager *ClientManager) Register(client types.IClient) {
    // æŠŠå®¢æˆ·ç«¯æ”¾å…¥æ³¨å†Œé€šé“
    manager.registerChan <- c
    // ä¸ä¼šç«‹å³æ·»åŠ ï¼Œè€Œæ˜¯é€šçŸ¥Run()æ–¹æ³•å¤„ç†
}
```

#### 2. Run - ä¸»äº‹ä»¶å¾ªç¯

```go
func (manager *ClientManager) Run() {
    for {
        select {
        case client := <-manager.registerChan:
            // å¤„ç†æ³¨å†Œ
            manager.registerClient(client)

        case client := <-manager.unregisterChan:
            // å¤„ç†æ³¨é”€
            manager.unregisterClient(client)

        case message := <-manager.broadcastChan:
            // å¤„ç†å¹¿æ’­
            manager.broadcastMessage(message)

        case userMsg := <-manager.userMsgChan:
            // å¤„ç†ç”¨æˆ·æ¶ˆæ¯
            manager.sendToUser(userMsg.userID, userMsg.Event, userMsg.message)
        }
    }
}
```

**ç”¨é¤å…ç†è§£ï¼š**
```
ClientManager.Run() = é¤å…ç»ç†çš„å·¥ä½œå¾ªç¯

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç»ç†åœ¨å¤§å…é‡Œï¼ŒåŒæ—¶å…³æ³¨4ä¸ªä¿¡å·ï¼š           â”‚
â”‚                                          â”‚
â”‚  â‘  registerChan    â†’ æœ‰æ–°å®¢äººï¼Œå®‰æ’åº§ä½  â”‚
â”‚  â‘¡ unregisterChan  â†’ å®¢äººèµ°äº†ï¼Œæ¸…ç†æ¡Œå­  â”‚
â”‚  â‘¢ broadcastChan   â†’ å…¨é¤å…å¹¿æ’­          â”‚
â”‚  â‘£ userMsgChan     â†’ ç»™ç‰¹å®šå®¢äººé€èœ      â”‚
â”‚                                          â”‚
â”‚  å“ªä¸ªä¿¡å·æ¥äº†ï¼Œå°±å¤„ç†å“ªä¸ª                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 4.4 æ¨¡å—â‘¢ï¼šè¿æ¥å¤„ç†é€»è¾‘

### è¿æ¥å¤„ç†æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SSE è¿æ¥å»ºç«‹çš„å®Œæ•´æµç¨‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®¢æˆ·ç«¯è¯·æ±‚                    æœåŠ¡å™¨å¤„ç†
    â”‚                             â”‚
    â”‚ GET /woolive/sse?token=xxx  â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
    â”‚                             â”‚
    â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     â”‚  1. æå–token    â”‚
    â”‚                     â”‚  token=r.URL... â”‚
    â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                             â”‚
    â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     â”‚  2. è§£æJWT     â”‚
    â”‚                     â”‚  éªŒè¯ç­¾å        â”‚
    â”‚                     â”‚  è·å–userId     â”‚
    â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                             â”‚
    â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     â”‚  3. RediséªŒè¯   â”‚
    â”‚                     â”‚  tokenæ˜¯å¦æœ‰æ•ˆ   â”‚
    â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                             â”‚
    â”‚     200 OK                  â”‚
    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚ Header:                     â”‚
    â”‚   Content-Type: event-streamâ”‚
    â”‚   Cache-Control: no-cache   â”‚
    â”‚   Connection: keep-alive    â”‚
    â”‚                             â”‚
    â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     â”‚  4. åˆ›å»ºClient  â”‚
    â”‚                     â”‚  ç”ŸæˆUUID       â”‚
    â”‚                     â”‚  åˆ›å»ºMessageCh  â”‚
    â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                             â”‚
    â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     â”‚  5. æ³¨å†Œåˆ°Mgr   â”‚
    â”‚                     â”‚  å­˜å…¥sync.Map   â”‚
    â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                             â”‚
    â”‚ <â”€â”€â”€â”€ connection_id â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚ <â”€â”€â”€â”€ heartbeat(initial) â”€â”€ â”‚
    â”‚                             â”‚
    â”‚        â”Œâ”€ å¯åŠ¨Listen â”€â”€â”€â”   â”‚
    â”‚        â”‚  ç›‘å¬MessageCh  â”‚   â”‚
    â”‚        â”‚  å‘é€å¿ƒè·³       â”‚   â”‚
    â”‚        â”‚  å¤„ç†æ–­å¼€       â”‚   â”‚
    â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
```

## 4.5 æ¨¡å—â‘£ï¼šæ¨é€é€»è¾‘

### æ¨é€æ¶ˆæ¯çš„å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å…¶ä»–æœåŠ¡è°ƒç”¨gRPCæ¨é€æ¶ˆæ¯                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¢å•æœåŠ¡                              SSEæœåŠ¡
    â”‚                                     â”‚
    â”‚ gRPC: PushToUsers({                 â”‚
    â”‚   userIds: ["user_001", "user_002"],â”‚
    â”‚   event: "order_created",           â”‚
    â”‚   jsonData: '{"order_no":"123"}'    â”‚
    â”‚ })                                  â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
    â”‚                                     â”‚
    â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                             â”‚ 1. å‚æ•°éªŒè¯     â”‚
    â”‚                             â”‚ æ£€æŸ¥å¿…è¦å­—æ®µ    â”‚
    â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                     â”‚
    â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                             â”‚ 2. éå†ç”¨æˆ·ID   â”‚
    â”‚                             â”‚ for userId ... â”‚
    â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                     â”‚
    â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                             â”‚ 3. è°ƒç”¨Mgræ–¹æ³•  â”‚
    â”‚                             â”‚ BroadcastToUserâ”‚
    â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                     â”‚
    â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                             â”‚ 4. æ”¾å…¥userMsgChâ”‚
    â”‚                             â”‚ éé˜»å¡ï¼Œç«‹å³è¿”å›â”‚
    â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                     â”‚
    â”‚ æ¨é€æˆåŠŸå“åº” <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚ {code:0, msg:"æ¨é€æˆåŠŸ"}             â”‚
    â”‚                                     â”‚
```

### å…³é”®è®¾è®¡ç‚¹

**ä¸ºä»€ä¹ˆè¦è¿”å›æˆåŠŸï¼Œä½†ä¸ä¿è¯é€è¾¾ï¼Ÿ**
```
å¼‚æ­¥æ¨é€æ¨¡å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¢å•æœåŠ¡ â”€â”€> SSEæœåŠ¡ â”€â”€> æ¶ˆæ¯æ”¾å…¥é˜Ÿåˆ— â”€â”€> ç«‹å³è¿”å›æˆåŠŸâ”‚
â”‚                    â”‚                         â”‚
â”‚                    â””â”€â”€> åå°æ…¢æ…¢æ¨é€ç»™ç”¨æˆ·     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹ï¼š
âœ“ è®¢å•æœåŠ¡ä¸ç”¨ç­‰å¾…æ¨é€å®Œæˆï¼Œå“åº”å¿«
âœ“ SSEæœåŠ¡å¯ä»¥æ§åˆ¶æ¨é€é€Ÿç‡ï¼Œä¿æŠ¤ç³»ç»Ÿ

ç¼ºç‚¹ï¼š
âœ— è®¢å•æœåŠ¡ä¸çŸ¥é“ç”¨æˆ·æ˜¯å¦çœŸçš„æ”¶åˆ°
âœ— éœ€è¦é¢å¤–æœºåˆ¶ç¡®ä¿æ¶ˆæ¯å¯é é€è¾¾
```

## 4.6 æ¨¡å—â‘¤ï¼šæœåŠ¡å¯åŠ¨

### æœåŠ¡å¯åŠ¨æµç¨‹

```go
func main() {
    // 1. åŠ è½½é…ç½®
    var c config.Config
    conf.MustLoad(*configFile, &c)

    // 2. åˆ›å»ºæœåŠ¡ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«Redisè¿æ¥ï¼‰
    ctx := svc.NewServiceContext(c)

    // 3. åˆ›å»ºClientManager
    clientManager := client.NewClientManager(ctx)

    // 4. å¯åŠ¨ClientManagerçš„goroutine
    go clientManager.Run()  // â† ç‹¬ç«‹goroutineè¿è¡Œäº‹ä»¶å¾ªç¯

    // 5. å°†Managerè®¾ç½®å›Context
    ctx.ClientMgr = clientManager

    // 6. å¯åŠ¨gRPCæœåŠ¡ï¼ˆå¤„ç†æ¨é€è¯·æ±‚ï¼‰
    grpcServer := zrpc.MustNewServer(c.SseRpc, func(s *grpc.Server) {
        pb.RegisterSSEServiceServer(s, server.NewSSEServiceServer(ctx))
    })

    // 7. å¯åŠ¨HTTPæœåŠ¡ï¼ˆå¤„ç†SSEè¿æ¥ï¼‰
    httpServer := rest.MustNewServer(c.RestConf, ...)
    routes.RegisterRoutes(httpServer, ctx)

    // 8. å¯åŠ¨å®šæ—¶å¹¿æ’­ä»»åŠ¡
    go tasks.StartPeriodicBroadcast(ctx)

    // 9. å¯åŠ¨æ‰€æœ‰æœåŠ¡
    group.Start()
}
```

### æœåŠ¡å¯åŠ¨åçš„goroutineåˆ†å¸ƒ

```
ä¸»è¿›ç¨‹
â”œâ”€ ä¸»goroutine (group.Start())
â”‚
â”œâ”€ ClientManager.Run()
â”‚  â””â”€ selectå¾ªç¯ç›‘å¬4ä¸ªchannel
â”‚
â”œâ”€ å®šæ—¶å¹¿æ’­ä»»åŠ¡
â”‚  â””â”€ æ¯30ç§’å¹¿æ’­å¿ƒè·³
â”‚
â”œâ”€ gRPCæœåŠ¡å¤„ç†goroutine
â”‚  â””â”€ å¤„ç†æ¨é€è¯·æ±‚
â”‚
â”œâ”€ HTTPæœåŠ¡å¤„ç†goroutine
â”‚  â”œâ”€ å®¢æˆ·ç«¯1çš„Listen()
â”‚  â”œâ”€ å®¢æˆ·ç«¯2çš„Listen()
â”‚  â”œâ”€ å®¢æˆ·ç«¯3çš„Listen()
â”‚  â””â”€ ...
â”‚
â””â”€ å…¶ä»–åå°ä»»åŠ¡
```

---

# é˜¶æ®µ5: åŠ¨æ‰‹å®è·µé¡¹ç›®

å­¦äº†è¿™ä¹ˆå¤šï¼Œç°åœ¨å¼€å§‹åŠ¨æ‰‹å®è·µï¼æˆ‘ä»¬ä¸€æ­¥æ­¥åšä¸€ä¸ªç®€å•çš„å³æ—¶é€šä¿¡Demoã€‚

## 5.1 å®è·µé¡¹ç›®è§„åˆ’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å®è·µé¡¹ç›®ï¼šç®€æ˜“èŠå¤©å®¤                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŠŸèƒ½ï¼š                                                   â”‚
â”‚  âœ“ ç”¨æˆ·è¿æ¥                                               â”‚
â”‚  âœ“ å‘é€æ¶ˆæ¯                                               â”‚
â”‚  âœ“ æ¥æ”¶æ¶ˆæ¯                                               â”‚
â”‚  âœ“ åœ¨çº¿åˆ—è¡¨                                               â”‚
â”‚  âœ“ å¿ƒè·³ä¿æ´»                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é¡¹ç›®ç»“æ„

```
my-chat/
â”œâ”€â”€ main.go          # ä¸»ç¨‹åº
â”œâ”€â”€ client.go        # å®¢æˆ·ç«¯ç®¡ç†
â”œâ”€â”€ handler.go       # HTTPå¤„ç†å‡½æ•°
â”œâ”€â”€ index.html       # å‰ç«¯é¡µé¢
â”œâ”€â”€ go.mod
â””â”€â”€ go.sum
```

## 5.2 å®ç°æ­¥éª¤

### æ­¥éª¤1ï¼šåˆ›å»ºé¡¹ç›®å¹¶åˆå§‹åŒ–

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir my-chat
cd my-chat

# åˆå§‹åŒ–Goæ¨¡å—
go mod init my-chat

# å®‰è£…ä¾èµ–
go get github.com/google/uuid
go get github.com/gorilla/mux
```

### æ­¥éª¤2ï¼šå®ç°å®¢æˆ·ç«¯ç®¡ç†ï¼ˆclient.goï¼‰

```go
package main

import (
	"encoding/json"
	"fmt"
	"net/http"
	"sync"

	"github.com/google/uuid"
)

// Client ä»£è¡¨ä¸€ä¸ªè¿æ¥çš„å®¢æˆ·ç«¯
type Client struct {
	ID             string
	Username       string
	MessageChannel chan []byte
}

// NewClient åˆ›å»ºæ–°å®¢æˆ·ç«¯
func NewClient(username string) *Client {
	return &Client{
		ID:             uuid.New().String(),
		Username:       username,
		MessageChannel: make(chan []byte, 100),
	}
}

// Send å‘é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
func (c *Client) Send(message []byte) bool {
	select {
	case c.MessageChannel <- message:
		return true
	default:
		return false // é€šé“æ»¡äº†ï¼Œæ¶ˆæ¯ä¸¢å¼ƒ
	}
}

// ClientManager ç®¡ç†æ‰€æœ‰å®¢æˆ·ç«¯
type ClientManager struct {
	clients      sync.Map // username -> *Client
	registerChan chan *Client
	broadcastChan chan []byte
	chatChan     chan *ChatMessage
}

// ChatMessage èŠå¤©æ¶ˆæ¯
type ChatMessage struct {
	From    string `json:"from"`
	Content string `json:"content"`
	Type    string `json:"type"` // chat, system, online_list
}

// NewClientManager åˆ›å»ºç®¡ç†å™¨
func NewClientManager() *ClientManager {
	return &ClientManager{
		registerChan:  make(chan *Client),
		broadcastChan: make(chan []byte, 100),
		chatChan:      make(chan *ChatMessage, 100),
	}
}

// Run å¯åŠ¨ç®¡ç†å™¨ä¸»å¾ªç¯
func (m *ClientManager) Run() {
	for {
		select {
		case client := <-m.registerChan:
			m.clients.Store(client.ID, client)
			welcome := fmt.Sprintf("æ¬¢è¿ %s åŠ å…¥èŠå¤©å®¤ï¼", client.Username)
			m.BroadcastSystemMessage(welcome)
			m.SendOnlineList()

		case message := <-m.broadcastChan:
			m.clients.Range(func(key, value interface{}) bool {
				client := value.(*Client)
				client.Send(message)
				return true
			})

		case chatMsg := <-m.chatChan:
			data, _ := json.Marshal(chatMsg)
			msg := formatSSE("chat", string(data))
			m.clients.Range(func(key, value interface{}) bool {
				client := value.(*Client)
				client.Send([]byte(msg))
				return true
			})
		}
	}
}
```

### æ­¥éª¤3ï¼šå®ç°HTTPå¤„ç†ï¼ˆhandler.goï¼‰

```go
package main

import (
	"encoding/json"
	"net/http"

	"github.com/gorilla/mux"
)

// SetupRoutes è®¾ç½®è·¯ç”±
func SetupRoutes(manager *ClientManager) *mux.Router {
	r := mux.NewRouter()

	// SSEè¿æ¥ç«¯ç‚¹
	r.HandleFunc("/sse", handleSSE(manager)).Methods("GET")

	// å‘é€æ¶ˆæ¯ç«¯ç‚¹
	r.HandleFunc("/send", handleSend(manager)).Methods("POST")

	// é™æ€æ–‡ä»¶
	r.PathPrefix("/").Handler(http.FileServer(http.Dir(".")))

	return r
}

// handleSSE å¤„ç†SSEè¿æ¥
func handleSSE(manager *ClientManager) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		// è®¾ç½®SSEå“åº”å¤´
		w.Header().Set("Content-Type", "text/event-stream")
		w.Header().Set("Cache-Control", "no-cache")
		w.Header().Set("Connection", "keep-alive")
		w.Header().Set("Access-Control-Allow-Origin", "*")

		// è·å–ç”¨æˆ·å
		username := r.URL.Query().Get("username")
		if username == "" {
			username = "åŒ¿åç”¨æˆ·"
		}

		// åˆ›å»ºå®¢æˆ·ç«¯
		client := NewClient(username)

		// å‘é€è¿æ¥ID
		connectionID := map[string]string{"id": client.ID}
		data, _ := json.Marshal(connectionID)
		sendSSE(w, "connection_id", string(data))

		// æ³¨å†Œå®¢æˆ·ç«¯
		manager.Register(client)

		// ç›‘å¬æ¶ˆæ¯å¹¶å‘é€
		flusher, _ := w.(http.Flusher)
		for message := range client.MessageChannel {
			fmt.Fprintf(w, "%s", message)
			flusher.Flush()
		}
	}
}

// handleSend å¤„ç†å‘é€æ¶ˆæ¯è¯·æ±‚
func handleSend(manager *ClientManager) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		var msg struct {
			From    string `json:"from"`
			Content string `json:"content"`
		}

		if err := json.NewDecoder(r.Body).Decode(&msg); err != nil {
			http.Error(w, err.Error(), http.StatusBadRequest)
			return
		}

		manager.SendChat(msg.From, msg.Content)
		w.WriteHeader(http.StatusOK)
	}
}

// sendSSE å‘é€SSEæ¶ˆæ¯
func sendSSE(w http.ResponseWriter, event, data string) {
	fmt.Fprintf(w, "event: %s\ndata: %s\n\n", event, data)
}

// formatSSE æ ¼å¼åŒ–SSEæ¶ˆæ¯
func formatSSE(event, data string) string {
	return fmt.Sprintf("event: %s\ndata: %s\n\n", event, data)
}
```

### æ­¥éª¤4ï¼šä¸»ç¨‹åºï¼ˆmain.goï¼‰

```go
package main

import (
	"log"
	"net/http"

	"github.com/gorilla/mux"
)

func main() {
	// åˆ›å»ºå®¢æˆ·ç«¯ç®¡ç†å™¨
	manager := NewClientManager()

	// å¯åŠ¨ç®¡ç†å™¨
	go manager.Run()

	// è®¾ç½®è·¯ç”±
	r := SetupRoutes(manager)

	// å¯åŠ¨æœåŠ¡å™¨
	log.Println("èŠå¤©å®¤æœåŠ¡å™¨å¯åŠ¨åœ¨ :8080")
	log.Fatal(http.ListenAndServe(":8080", r))
}
```

### æ­¥éª¤5ï¼šå‰ç«¯é¡µé¢ï¼ˆindex.htmlï¼‰

```html
<!DOCTYPE html>
<html>
<head>
    <title>ç®€æ˜“èŠå¤©å®¤</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #messages { height: 400px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; background: #f9f9f9; }
        .message { margin: 5px 0; padding: 8px; border-radius: 4px; }
        .chat { background: #e3f2fd; }
        .system { background: #fff3cd; color: #856404; }
        .online { background: #d4edda; }
        #input { display: flex; gap: 10px; margin-top: 20px; }
        #input input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        #input button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #input button:hover { background: #0056b3; }
        #status { padding: 10px; background: #d4edda; margin-bottom: 20px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ’¬ ç®€æ˜“èŠå¤©å®¤</h1>

    <div>
        <label>ä½ çš„æ˜µç§°ï¼š</label>
        <input type="text" id="username" placeholder="è¾“å…¥æ˜µç§°...">
        <button onclick="connect()">è¿æ¥</button>
    </div>

    <div id="status">æœªè¿æ¥</div>

    <div id="messages"></div>

    <div id="input">
        <input type="text" id="message" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled>
        <button onclick="sendMessage()" id="sendBtn" disabled>å‘é€</button>
    </div>

    <script>
        let eventSource = null;
        let myUsername = '';

        function connect() {
            myUsername = document.getElementById('username').value || 'åŒ¿åç”¨æˆ·';

            // å»ºç«‹SSEè¿æ¥
            eventSource = new EventSource('/sse?username=' + encodeURIComponent(myUsername));

            // ç›‘å¬è¿æ¥IDäº‹ä»¶
            eventSource.addEventListener('connection_id', function(e) {
                const data = JSON.parse(e.data);
                document.getElementById('status').textContent = 'å·²è¿æ¥ï¼ID: ' + data.id;
                document.getElementById('message').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                addMessage('ç³»ç»Ÿ', 'è¿æ¥æˆåŠŸï¼ä½ å¯ä»¥å¼€å§‹èŠå¤©äº†', 'system');
            });

            // ç›‘å¬èŠå¤©æ¶ˆæ¯
            eventSource.addEventListener('chat', function(e) {
                const data = JSON.parse(e.data);
                addMessage(data.from, data.content, 'chat');
            });

            // ç›‘å¬åœ¨çº¿åˆ—è¡¨
            eventSource.addEventListener('online_list', function(e) {
                const users = JSON.parse(e.data);
                addMessage('ç³»ç»Ÿ', 'åœ¨çº¿ç”¨æˆ·: ' + users.join(', '), 'online');
            });

            // é”™è¯¯å¤„ç†
            eventSource.onerror = function(e) {
                document.getElementById('status').textContent = 'è¿æ¥å‡ºé”™';
                console.error('SSEé”™è¯¯:', e);
            };
        }

        function sendMessage() {
            const input = document.getElementById('message');
            const text = input.value;
            if (!text) return;

            fetch('/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    from: myUsername,
                    content: text
                })
            });

            input.value = '';
        }

        function addMessage(from, text, type) {
            const messagesDiv = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'message ' + type;
            div.textContent = from + ': ' + text;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // å›è½¦å‘é€
        document.getElementById('message').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
```

### æ­¥éª¤6ï¼šè¿è¡Œæµ‹è¯•

```bash
# è¿è¡ŒæœåŠ¡å™¨
go run main.go client.go handler.go

# æ‰“å¼€æµè§ˆå™¨è®¿é—®
open http://localhost:8080
```

## 5.3 é¡¹ç›®æ‰©å±•ç»ƒä¹ 

å®ŒæˆåŸºç¡€é¡¹ç›®åï¼Œå¯ä»¥å°è¯•ä»¥ä¸‹æ‰©å±•ï¼š

### ç»ƒä¹ 1ï¼šæ·»åŠ å¿ƒè·³æœºåˆ¶

```go
// åœ¨ client.go ä¸­æ·»åŠ 
func (c *Client) startHeartbeat(w http.ResponseWriter) {
    ticker := time.NewTicker(30 * time.Second)
    go func() {
        for range ticker.C {
            heartbeat := map[string]interface{}{
                "type": "heartbeat",
                "time": time.Now().Unix(),
            }
            data, _ := json.Marshal(heartbeat)
            msg := formatSSE("heartbeat", string(data))
            c.Send([]byte(msg))
        }
    }()
}
```

### ç»ƒä¹ 2ï¼šæ·»åŠ JWTè®¤è¯

```bash
# å®‰è£…JWTåº“
go get github.com/dgrijalva/jwt-go

# å®ç°ç™»å½•æ¥å£
POST /login
{
    "username": "user",
    "password": "pass"
}

# è¿”å›token
{
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### ç»ƒä¹ 3ï¼šæ·»åŠ æ¶ˆæ¯æŒä¹…åŒ–

```go
// ä½¿ç”¨Rediså­˜å‚¨æ¶ˆæ¯å†å²
type MessageHistory struct {
    From    string
    Content string
    Time    time.Time
}

// è¿æ¥æ—¶å‘é€å†å²æ¶ˆæ¯
func (m *ClientManager) SendHistory(client *Client) {
    history := getHistoryFromRedis(client.ID)
    for _, msg := range history {
        data, _ := json.Marshal(msg)
        client.Send([]byte(formatSSE("history", string(data))))
    }
}
```

### ç»ƒä¹ 4ï¼šæ”¯æŒç§èŠ

```go
// ä¿®æ”¹ChatMessageç»“æ„
type ChatMessage struct {
    From    string `json:"from"`
    To      string `json:"to,omitempty"` // ç§èŠç›®æ ‡
    Content string `json:"content"`
    Type    string `json:"type"`
}

// åœ¨SendChatä¸­å¤„ç†ç§èŠ
func (m *ClientManager) SendChat(from, to, content string) {
    msg := ChatMessage{
        From:    from,
        To:      to,
        Content: content,
        Type:    "chat",
    }

    if to == "" {
        // å…¬èŠï¼Œå¹¿æ’­ç»™æ‰€æœ‰äºº
        m.chatChan <- &msg
    } else {
        // ç§èŠï¼Œåªå‘ç»™ç›®æ ‡ç”¨æˆ·
        m.sendToUser(to, &msg)
    }
}
```

---

# æ€»ç»“

é€šè¿‡è¿™5ä¸ªé˜¶æ®µçš„å­¦ä¹ ï¼Œä½ åº”è¯¥å·²ç»æŒæ¡äº†ï¼š

1. **å³æ—¶é€šä¿¡çš„åŸºç¡€æ¦‚å¿µ**ï¼šäº†è§£IMç³»ç»Ÿçš„æ ¸å¿ƒç»„æˆå’Œå·¥ä½œåŸç†
2. **SSEæŠ€æœ¯åŸç†**ï¼šæŒæ¡SSEçš„æ¶ˆæ¯æ ¼å¼ã€å¿ƒè·³æœºåˆ¶å’Œä¼˜ç¼ºç‚¹
3. **Goå¹¶å‘ç¼–ç¨‹**ï¼šç†è§£goroutineã€channelã€selectå’Œsync.Map
4. **é¡¹ç›®ä»£ç ç»“æ„**ï¼šç†Ÿæ‚‰gow.sse.baseé¡¹ç›®çš„æ ¸å¿ƒæ¨¡å—
5. **åŠ¨æ‰‹å®è·µèƒ½åŠ›**ï¼šèƒ½å¤Ÿç‹¬ç«‹å¼€å‘ä¸€ä¸ªç®€å•çš„å³æ—¶é€šä¿¡Demo

## ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®

1. **æ·±å…¥å­¦ä¹ WebSocket**ï¼šå¯¹æ¯”SSEï¼Œäº†è§£åŒå‘é€šä¿¡çš„å®ç°
2. **å­¦ä¹ æ¶ˆæ¯é˜Ÿåˆ—**ï¼šäº†è§£å¦‚ä½•ä½¿ç”¨Kafkaã€RabbitMQç­‰MQç³»ç»Ÿ
3. **åˆ†å¸ƒå¼ç³»ç»Ÿ**ï¼šå­¦ä¹ å¦‚ä½•å®ç°åˆ†å¸ƒå¼IMç³»ç»Ÿ
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šå­¦ä¹ å¦‚ä½•ä¼˜åŒ–é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½
5. **å®‰å…¨åŠ å›º**ï¼šäº†è§£å¦‚ä½•é˜²æ­¢å„ç§ç½‘ç»œæ”»å‡»

## å‚è€ƒèµ„æº

- gow.sse.baseé¡¹ç›®ä»£ç 
- [MDN Server-Sent Events](https://developer.mozilla.org/zh-CN/docs/Web/API/Server-sent_events)
- [Go by Example: Goroutines](https://gobyexample.com/goroutines)
- [Go by Example: Channels](https://gobyexample.com/channels)

---

**ç¥ä½ å­¦ä¹ é¡ºåˆ©ï¼ğŸ‰**
